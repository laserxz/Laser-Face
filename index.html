<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LaserFace ‚Äî OSC Bridge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #0a0a0c;
  --bg1:      #0f0f12;
  --bg2:      #141418;
  --bg3:      #1a1a20;
  --border:   #242430;
  --border2:  #2e2e3c;
  --cyan:     #00d4ff;
  --cyan-dim: #0088aa;
  --amber:    #ffaa00;
  --amber-dim:#885500;
  --green:    #00ff88;
  --green-dim:#006633;
  --red:      #ff3344;
  --red-dim:  #661122;
  --white:    #f0f0f8;
  --grey:     #888898;
  --grey2:    #555565;
  --font-ui:  'Rajdhani', sans-serif;
  --font-mono:'JetBrains Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--white);
  font-family: var(--font-ui);
  font-size: 15px;
  font-weight: 500;
  min-height: 100vh;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 1100px;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: baseline;
  gap: 14px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
.header-title {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--white);
}
.header-title span { color: var(--cyan); }
.header-sub {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--grey2);
  letter-spacing: 1px;
}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--bg1);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.card-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--grey2);
  margin-bottom: 2px;
}

/* ‚îÄ‚îÄ ROW ‚îÄ‚îÄ */
.row {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
button {
  font-family: var(--font-ui);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 9px 18px;
  border-radius: 4px;
  border: 1px solid var(--border2);
  background: var(--bg2);
  color: var(--grey);
  cursor: pointer;
  transition: all 0.12s;
  white-space: nowrap;
}
button:hover { background: var(--bg3); color: var(--white); border-color: var(--grey); }
button:disabled { opacity: 0.3; cursor: default; }

button.pri {
  background: rgba(0,212,255,0.08);
  border-color: var(--cyan-dim);
  color: var(--cyan);
}
button.pri:hover { background: rgba(0,212,255,0.16); border-color: var(--cyan); }

button.go {
  background: rgba(0,255,136,0.08);
  border-color: var(--green-dim);
  color: var(--green);
  font-size: 16px;
  padding: 11px 24px;
}
button.go:hover { background: rgba(0,255,136,0.16); border-color: var(--green); }

button.red {
  background: rgba(255,51,68,0.08);
  border-color: var(--red-dim);
  color: var(--red);
}
button.red:hover { background: rgba(255,51,68,0.16); border-color: var(--red); }

button.sm {
  font-size: 12px;
  padding: 5px 12px;
  letter-spacing: 1px;
}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
input[type=text], input[type=number], select {
  font-family: var(--font-mono);
  font-size: 13px;
  padding: 8px 10px;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: 4px;
  color: var(--white);
  outline: none;
  transition: border-color 0.12s;
}
input[type=text]:focus,
input[type=number]:focus,
select:focus { border-color: var(--cyan-dim); }
select { cursor: pointer; }
select option { background: var(--bg2); }

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  padding: 4px 10px;
  border-radius: 3px;
  text-transform: uppercase;
}
.badge.g { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid var(--green-dim); box-shadow: 0 0 8px rgba(0,255,136,0.2); }
.badge.r { background: rgba(255,51,68,0.1);  color: var(--red);   border: 1px solid var(--red-dim); }
.badge.a { background: rgba(255,170,0,0.1);  color: var(--amber); border: 1px solid var(--amber-dim); }

/* ‚îÄ‚îÄ CONNECTION BAR ‚îÄ‚îÄ */
.conn-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.conn-divider { width: 1px; height: 28px; background: var(--border2); margin: 0 4px; }

/* ‚îÄ‚îÄ OSC CONFIG ‚îÄ‚îÄ */
.osc-cfg {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.osc-cfg-header {
  display: flex;
  align-items: center;
  gap: 10px;
}
.osc-cfg-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--cyan-dim);
}
.osc-panel { display: none; flex-direction: column; gap: 6px; margin-top: 4px; }
.osc-row {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
}
.osc-lbl {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 1px;
  color: var(--grey);
  min-width: 160px;
}
.osc-addr {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--cyan);
  background: rgba(0,212,255,0.05);
  border: 1px solid rgba(0,212,255,0.15);
  padding: 3px 8px;
  border-radius: 3px;
  flex: 1;
}
.osc-hint { font-size: 11px; color: var(--grey2); }

/* ‚îÄ‚îÄ TC BAR ‚îÄ‚îÄ */
.tc-bar {
  background: var(--bg1);
  border: 1px solid var(--border);
  border-left: 3px solid var(--cyan-dim);
  border-radius: 6px;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-wrap: wrap;
}
.tc-label {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--cyan-dim);
  min-width: 80px;
}
.tc-display {
  font-family: var(--font-mono);
  font-size: 28px;
  font-weight: 700;
  color: var(--cyan);
  letter-spacing: 3px;
  font-variant-numeric: tabular-nums;
  text-shadow: 0 0 20px rgba(0,212,255,0.4);
  min-width: 200px;
}
.tc-status {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--grey2);
  letter-spacing: 1px;
}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs {
  display: flex;
  gap: 2px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 3px;
}
.tab {
  flex: 1;
  padding: 10px;
  text-align: center;
  font-family: var(--font-ui);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  border-radius: 4px;
  color: var(--grey2);
  transition: all 0.15s;
}
.tab:hover { color: var(--white); background: var(--bg2); }
.tab.on {
  background: var(--bg3);
  color: var(--cyan);
  box-shadow: inset 0 0 0 1px var(--cyan-dim);
}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel { display: none; flex-direction: column; gap: 12px; }
.panel.on { display: flex; }

/* ‚îÄ‚îÄ SECTION HEADING ‚îÄ‚îÄ */
h2 {
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--grey2);
  margin-bottom: 2px;
}

/* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
canvas {
  display: block;
  border: 1px solid var(--border2);
  border-radius: 6px;
  max-width: 100%;
}
.vid-wrap { position: relative; display: inline-block; }
.vid-ovr {
  position: absolute;
  bottom: 10px;
  left: 10px;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  color: var(--amber);
  background: rgba(0,0,0,0.7);
  padding: 4px 10px;
  border-radius: 3px;
  pointer-events: none;
}

/* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
.pbar {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  height: 24px;
  overflow: hidden;
  position: relative;
}
.pfill {
  height: 100%;
  background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s;
}
.plbl {
  position: absolute;
  inset: 0;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 24px;
  color: var(--white);
  font-weight: 500;
}

/* ‚îÄ‚îÄ PARAM GRID ‚îÄ‚îÄ */
.pgrid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}
.pg {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 7px 9px;
}
.pgn {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--grey2);
  margin-bottom: 5px;
  display: flex;
  justify-content: space-between;
  align-items: baseline;
}
.pgn span { font-size: 10px; color: var(--grey2); opacity: 0.5; font-weight: 400; }
.pgb {
  background: var(--bg2);
  height: 6px;
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 3px;
}
.pgf {
  height: 100%;
  border-radius: 2px;
  width: 0%;
  transition: width 50ms;
}
.pgv {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--grey2);
  text-align: right;
}

/* ‚îÄ‚îÄ TRIGGER ROWS ‚îÄ‚îÄ */
.tr-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
}

/* ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ */
#countdown {
  font-family: var(--font-mono);
  font-size: 96px;
  font-weight: 700;
  color: var(--cyan);
  text-align: center;
  padding: 24px;
  display: none;
  text-shadow: 0 0 40px rgba(0,212,255,0.6);
  letter-spacing: 8px;
}

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
#statusbar {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--amber);
  letter-spacing: 0.5px;
  min-height: 20px;
  padding: 4px 0;
  border-top: 1px solid var(--border);
}

.data-info {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--green);
  letter-spacing: 0.5px;
}

.hint {
  font-size: 13px;
  color: var(--grey2);
  line-height: 1.6;
}
.hint b { color: var(--cyan); font-weight: 600; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-title">Laser<span>Face</span></div>
  <div class="header-sub">MEDIAPIPE ‚Üí OSC ‚Üí PANGOLIN BEYOND  //  v4</div>
</div>

<!-- CONNECTION -->
<div class="card">
  <div class="card-label">Connection</div>
  <div class="conn-bar">
    <span class="badge r" id="osc-badge">OSC</span>
    <input type="text" id="osc-url" value="ws://localhost:8081" style="flex:1;min-width:180px">
    <button class="pri" id="btn-osc-connect">Connect</button>
    <div class="conn-divider"></div>
    <span class="badge r" id="midi-badge">MIDI</span>
    <select id="midiOut" style="flex:1;min-width:140px"><option value="">‚Äî no MIDI output ‚Äî</option></select>
  </div>
</div>

<!-- OSC ADDRESS CONFIG -->
<div class="osc-cfg">
  <div class="osc-cfg-header">
    <div class="osc-cfg-title">Beyond OSC Addresses</div>
    <span class="hint" style="font-size:12px">‚Äî native /beyond/ direct control, no PangoScript needed</span>
    <button class="sm" id="btn-show-osc" style="margin-left:auto">‚ñº Configure</button>
  </div>
  <div class="osc-panel" id="osc-addr-panel">
    <div class="osc-row">
      <span class="osc-lbl">Zone name</span>
      <input type="text" id="cfg-zone" value="FACE" style="width:110px">
      <span class="osc-hint">‚Üí /beyond/zone/FACE/livecontrol/angley etc.</span>
    </div>
    <div class="osc-row">
      <span class="osc-lbl">Cue page index</span>
      <input type="number" id="cfg-page" value="0" min="0" max="99" style="width:60px">
      <span class="osc-hint">page 0 = first page in Beyond grid (0-based)</span>
    </div>
    <div class="osc-row">
      <span class="osc-lbl">MOUTH cue index</span>
      <input type="number" id="cfg-mouth" value="0" min="0" max="99" style="width:60px">
    </div>
    <div class="osc-row">
      <span class="osc-lbl">LEFTEYE cue index</span>
      <input type="number" id="cfg-leye" value="1" min="0" max="99" style="width:60px">
    </div>
    <div class="osc-row">
      <span class="osc-lbl">RIGHTEYE cue index</span>
      <input type="number" id="cfg-reye" value="2" min="0" max="99" style="width:60px">
    </div>
    <div class="osc-row">
      <span class="osc-lbl">BROWS cue index</span>
      <input type="number" id="cfg-brows" value="3" min="0" max="99" style="width:60px">
    </div>
    <div id="addr-preview" style="display:flex;flex-direction:column;gap:4px;margin-top:4px"></div>
  </div>
</div>

<!-- ARTNET TC BAR -->
<div class="tc-bar">
  <span class="tc-label">ArtNet TC</span>
  <select id="tc-mode">
    <option value="off">Off ‚Äî manual sync</option>
    <option value="send" selected>Send ‚Äî Bridge ‚Üí Beyond</option>
    <option value="receive">Receive ‚Äî Beyond ‚Üí Bridge</option>
  </select>
  <select id="tc-fps" style="width:110px">
    <option value="30" selected>30 fps</option>
    <option value="25">25 fps (PAL)</option>
    <option value="24">24 fps (film)</option>
    <option value="29.97">29.97 fps</option>
  </select>
  <input type="text" id="tc-host" value="2.255.255.255" style="width:150px" title="ArtNet broadcast / Beyond IP">
  <span class="tc-display" id="tc-display">--:--:--:--</span>
  <span class="tc-status" id="tc-status">idle</span>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab on" data-p="live">üé• Live</div>
  <div class="tab" data-p="process">‚öô Process Video</div>
  <div class="tab" data-p="playback">‚ñ∂ Playback</div>
</div>

<!-- ‚îÄ‚îÄ LIVE PANEL ‚îÄ‚îÄ -->
<div class="panel on" id="panel-live">
  <div class="card">
    <h2>Video Source</h2>
    <div class="row">
      <button class="go" id="btn-webcam">üì∑ Webcam</button>
      <button id="btn-capture">üñ• Capture Window</button>
      <span class="hint" style="font-size:12px">‚Üê capture Beyond's video preview for video-driven tracking</span>
      <button class="red" id="btn-stop-live" style="margin-left:auto">‚ñ† Stop</button>
    </div>
  </div>
  <div class="vid-wrap">
    <canvas id="canvas-live" width="640" height="360"></canvas>
    <div class="vid-ovr" id="live-ovr">Idle</div>
  </div>
  <div class="pgrid" id="pg-live"></div>
</div>

<!-- ‚îÄ‚îÄ PROCESS PANEL ‚îÄ‚îÄ -->
<div class="panel" id="panel-process">
  <div class="card">
    <h2>1 ‚Äî Load Video File</h2>
    <input type="file" id="video-file" accept="video/*" style="color:var(--grey);font-size:14px;font-family:var(--font-ui)">
    <video id="video-proc" style="max-width:100%;border:1px solid var(--border2);border-radius:6px;display:none;margin-top:6px" controls></video>
  </div>
  <div class="card">
    <h2>2 ‚Äî Process Frames</h2>
    <div class="row">
      <span class="hint">FPS</span>
      <input type="number" id="proc-fps" value="30" min="1" max="60" style="width:64px">
      <button class="pri" id="btn-process">‚öô Process All Frames</button>
      <button class="red" id="btn-stop-proc" style="display:none">‚ñ† Stop</button>
      <span id="proc-stats" style="font-family:var(--font-mono);font-size:12px;color:var(--grey2);margin-left:auto"></span>
    </div>
    <div class="pbar"><div class="pfill" id="proc-pf"></div><div class="plbl" id="proc-pl">Ready</div></div>
  </div>
  <div class="card">
    <h2>3 ‚Äî OSC Triggers <span style="font-size:11px;font-weight:400;letter-spacing:0;text-transform:none;color:var(--grey2)">‚Äî fired at exact timestamps during playback</span></h2>
    <div id="trigger-list" style="display:flex;flex-direction:column"></div>
    <div class="row" style="margin-top:6px">
      <button id="btn-add-tr">+ Add Trigger</button>
      <button id="btn-auto-tr">‚ö° Auto ‚Äî start all face cues @ t=0</button>
    </div>
  </div>
  <div class="card">
    <h2>4 ‚Äî Export</h2>
    <div class="row">
      <button class="go" id="btn-export" disabled>üíæ Download face-data.json</button>
      <button class="pri" id="btn-upload" disabled>‚¨Ü Send to Bridge</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ PLAYBACK PANEL ‚îÄ‚îÄ -->
<div class="panel" id="panel-playback">
  <div class="card">
    <h2>Load face-data.json</h2>
    <div class="row">
      <input type="file" id="data-file" accept=".json" style="color:var(--grey);font-size:14px;font-family:var(--font-ui);flex:1">
      <span class="data-info" id="data-info"></span>
    </div>
  </div>
  <div class="card">
    <h2>Sync &amp; Play</h2>
    <div class="hint" style="margin-bottom:10px">
      <b>TC Send:</b> Bridge sends ArtNet TC from 00:00:00:00. Beyond Timeline TC-IN must be ON and show in waiting state.<br>
      <b>Play + Countdown:</b> countdown gives you time to focus Beyond before both fire simultaneously.<br>
      <b>Play Now:</b> immediate ‚Äî use when Beyond is already in waiting state.
    </div>
    <div class="row">
      <input type="number" id="cd-secs" value="3" min="1" max="9" style="width:56px">
      <span class="hint">sec</span>
      <button class="go" id="btn-play" disabled>‚ñ∂ Play + Countdown</button>
      <button class="pri" id="btn-play-now" disabled>‚ñ∂ Play Now</button>
      <button class="red" id="btn-stop-pb" style="display:none">‚ñ† Stop</button>
    </div>
    <div id="countdown">3</div>
    <div class="pbar" style="margin-top:8px"><div class="pfill" id="pb-pf"></div><div class="plbl" id="pb-pl">‚Äî</div></div>
  </div>
  <div class="pgrid" id="pg-pb"></div>
</div>

<div id="statusbar">Ready ‚Äî connect OSC bridge: cd face-osc-bridge &amp;&amp; npm start</div>
<video id="vid-live-el" style="display:none" autoplay playsinline></video>

<script>
function getOSCMap(){
  const zone  = document.getElementById('cfg-zone').value.trim() || 'FACE';
  const page  = parseInt(document.getElementById('cfg-page').value)||0;
  const mouth = parseInt(document.getElementById('cfg-mouth').value)||0;
  const leye  = parseInt(document.getElementById('cfg-leye').value)||1;
  const reye  = parseInt(document.getElementById('cfg-reye').value)||2;
  const brows = parseInt(document.getElementById('cfg-brows').value)||3;
  const Z = `/beyond/zone/${zone}/livecontrol`;
  const C = (i)=>`/beyond/cue/${page}/${i}/livecontrol`;
  return {
    yaw:         {addr:`${Z}/angley`,           scale:(v)=>(v-0.5)*90.0},
    pitch:       {addr:`${Z}/anglex`,           scale:(v)=>(v-0.5)*60.0},
    roll:        {addr:`${Z}/anglez`,           scale:(v)=>(v-0.5)*60.0},
    jawOpen:     {addr:`${C(mouth)}/sizey`,     scale:(v)=> 5+(v*95)},
    smile:       {addr:`${C(mouth)}/fx1action`, scale:(v)=>v*100},
    frown:       {addr:`${C(mouth)}/fx2action`, scale:(v)=>v*100},
    pucker:      {addr:`${C(mouth)}/fx3action`, scale:(v)=>v*100},
    funnel:      {addr:`${C(mouth)}/fx4action`, scale:(v)=>v*100},
    leye:        {addr:`${C(leye)}/sizey`,      scale:(v)=>10+(v*90)},
    reye:        {addr:`${C(reye)}/sizey`,      scale:(v)=>10+(v*90)},
    squint:      {addr:`${C(leye)}/fx1action`,  scale:(v)=>v*100},
    wide:        {addr:`${C(leye)}/fx2action`,  scale:(v)=>v*100},
    browInnerUp: {addr:`${C(brows)}/fx1action`, scale:(v)=>v*100},
    browOuterUp: {addr:`${C(brows)}/fx2action`, scale:(v)=>v*100},
    browDown:    {addr:`${C(brows)}/fx3action`, scale:(v)=>v*100},
    _squintR:    {addr:`${C(reye)}/fx1action`,  scale:(v)=>v*100, src:'squint'},
    _wideR:      {addr:`${C(reye)}/fx2action`,  scale:(v)=>v*100, src:'wide'},
  };
}

function updateAddrPreview(){
  const map=getOSCMap();
  const el=document.getElementById('addr-preview');
  const entries=[
    ['Yaw ‚Üí angley',   map.yaw.addr],
    ['Pitch ‚Üí anglex', map.pitch.addr],
    ['Roll ‚Üí anglez',  map.roll.addr],
    ['Jaw ‚Üí sizey',    map.jawOpen.addr],
    ['Smile ‚Üí fx1',    map.smile.addr],
    ['L.Eye ‚Üí sizey',  map.leye.addr],
    ['R.Eye ‚Üí sizey',  map.reye.addr],
    ['Brow‚Üë ‚Üí fx1',    map.browInnerUp.addr],
  ];
  el.innerHTML=entries.map(([l,a])=>
    `<div class="osc-row"><span class="osc-lbl">${l}</span><span class="osc-addr">${a}</span></div>`
  ).join('');
}

document.getElementById('btn-show-osc').addEventListener('click',()=>{
  const p=document.getElementById('osc-addr-panel');
  const vis=p.style.display==='flex';
  p.style.display=vis?'none':'flex';
  document.getElementById('btn-show-osc').textContent=vis?'‚ñº Configure':'‚ñ≤ Hide';
  if(!vis) updateAddrPreview();
});
['cfg-zone','cfg-page','cfg-mouth','cfg-leye','cfg-reye','cfg-brows'].forEach(id=>{
  document.getElementById(id).addEventListener('change',updateAddrPreview);
});
</script>

<script type="module">
import{FaceLandmarker,FilesetResolver,DrawingUtils}
  from"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/vision_bundle.mjs";

const PARAMS=['yaw','pitch','roll','jawOpen','smile','frown','leye','reye',
              'squint','wide','browInnerUp','browOuterUp','browDown','pucker','funnel','cheekPuff'];
const PCOLS={
  yaw:'#00d4ff',pitch:'#00d4ff',roll:'#00d4ff',
  jawOpen:'#ffaa00',smile:'#ffaa00',frown:'#ffaa00',pucker:'#ffaa00',funnel:'#ffaa00',cheekPuff:'#ffaa00',
  leye:'#00ff88',reye:'#00ff88',squint:'#00ff88',wide:'#00ff88',
  browInnerUp:'#ff88cc',browOuterUp:'#ff88cc',browDown:'#ff88cc'
};
const CC_MAP={yaw:1,pitch:2,leye:3,reye:4,roll:5,smile:6,
              browInnerUp:7,browDown:8,jawOpen:11,frown:12,
              wide:13,squint:14,pucker:15,funnel:16,cheekPuff:17,browOuterUp:18};

const EK=0.2,ES={};
function ema(k,v){ES[k]=(ES[k]??v)+EK*(v-(ES[k]??v));return ES[k];}

let ws=null;
function connectOSC(){
  const url=document.getElementById('osc-url').value.trim();
  if(ws){ws.close();ws=null;}
  ws=new WebSocket(url);
  ws.onopen =()=>{bdg('osc-badge','OSC','g');sendWS({type:'tcMode',mode:tcMode(),fps:tcFPS(),host:tcHost()});}
  ws.onclose=()=>{bdg('osc-badge','OSC','r');ws=null;}
  ws.onerror=()=> bdg('osc-badge','OSC','r');
  ws.onmessage=e=>{
    const m=JSON.parse(e.data);
    if(m.type==='tc'){showTC(m.timeMs);document.getElementById('tc-status').textContent='‚Üê rcv';}
    if(m.type==='dataLoaded') st(`Bridge: ${m.frames} frames loaded`);
  };
}
document.getElementById('btn-osc-connect').addEventListener('click',connectOSC);
setTimeout(connectOSC,300);

function sendWS(obj){if(ws?.readyState===1)ws.send(JSON.stringify(obj));}
function tcMode(){return document.getElementById('tc-mode').value;}
function tcFPS(){return parseFloat(document.getElementById('tc-fps').value)||30;}
function tcHost(){return document.getElementById('tc-host').value.trim()||'2.255.255.255';}

['tc-mode','tc-fps','tc-host'].forEach(id=>{
  document.getElementById(id).addEventListener('change',()=>{
    sendWS({type:'tcMode',mode:tcMode(),fps:tcFPS(),host:tcHost()});
  });
});

let midiAccess=null,midiOut=null;
async function initMIDI(){
  if(!navigator.requestMIDIAccess)return;
  midiAccess=await navigator.requestMIDIAccess();
  const ref=()=>{
    const sel=document.getElementById('midiOut'),prev=sel.value;sel.innerHTML='';
    for(const[id,o]of midiAccess.outputs){
      const x=document.createElement('option');x.value=id;x.textContent=o.name;sel.appendChild(x);
    }
    if(sel.options.length){
      if([...midiAccess.outputs.keys()].includes(prev))sel.value=prev;
      midiOut=midiAccess.outputs.get(sel.value)||null;bdg('midi-badge','MIDI','g');
    }
  };
  midiAccess.onstatechange=ref;ref();
}
document.getElementById('midiOut').addEventListener('change',e=>{midiOut=midiAccess?.outputs.get(e.target.value)||null;});
initMIDI();

const lastSent={};
const THRESH=0.004;

function dispatchOSC(params,timeMs=null){
  const oscMap=getOSCMap();
  const out=[];
  for(const[key,cfg]of Object.entries(oscMap)){
    const srcKey=cfg.src||key;
    const val=params[srcKey];
    if(val===undefined) continue;
    const scaled=cfg.scale(val);
    const cacheKey=cfg.addr;
    if(Math.abs(scaled-(lastSent[cacheKey]??-9999))>=THRESH){
      lastSent[cacheKey]=scaled;
      out.push({addr:cfg.addr,val:scaled});
    }
  }
  if(out.length){
    if(timeMs!==null) sendWS({type:'playback',timeMs,osc:out});
    else sendWS({type:'oscBatch',osc:out});
  }
  if(midiOut){
    PARAMS.forEach(k=>{
      const cc=CC_MAP[k];if(!cc||params[k]===undefined)return;
      midiOut.send([0xB0,cc,Math.max(0,Math.min(127,Math.round(params[k]*127)))]);
    });
  }
}

function showTC(ms){
  const fps=tcFPS();
  const h=Math.floor(ms/3600000)%24,m=Math.floor(ms/60000)%60,
        s=Math.floor(ms/1000)%60,f=Math.floor((ms%1000)/(1000/fps));
  document.getElementById('tc-display').textContent=`${p2(h)}:${p2(m)}:${p2(s)}:${p2(f)}`;
}
function p2(n){return String(Math.floor(n)).padStart(2,'0');}
function bdg(id,lbl,cls){const e=document.getElementById(id);e.textContent=lbl;e.className='badge '+cls;}
function st(t){document.getElementById('statusbar').textContent=t;}

function buildPG(id){
  const c=document.getElementById(id);c.innerHTML='';
  PARAMS.forEach(n=>{
    c.innerHTML+=`<div class="pg">
      <div class="pgn">${n}<span>CC${CC_MAP[n]||'‚Äî'}</span></div>
      <div class="pgb"><div class="pgf" id="pf-${id}-${n}" style="background:${PCOLS[n]||'#00d4ff'}"></div></div>
      <div class="pgv" id="pv-${id}-${n}">0.00</div></div>`;
  });
}
function updPG(id,p){
  PARAMS.forEach(n=>{
    const v=p[n]??0;
    const f=document.getElementById(`pf-${id}-${n}`);
    const ve=document.getElementById(`pv-${id}-${n}`);
    if(f)f.style.width=(v*100).toFixed(0)+'%';
    if(ve)ve.textContent=v.toFixed(2);
  });
}
buildPG('pg-live');buildPG('pg-pb');

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('on'));
  t.classList.add('on');
  document.getElementById('panel-'+t.dataset.p).classList.add('on');
}));

let flV=null,flI=null;
const canvasL=document.getElementById('canvas-live');
const ctxL=canvasL.getContext('2d');
const vidL=document.getElementById('vid-live-el');
let drawU=null;
const zero={yaw:0,pitch:0,roll:0};

async function initMP(){
  st('Loading MediaPipe model...');
  const vis=await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/wasm");
  const MODEL="https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task";
  const base={modelAssetPath:MODEL,delegate:'GPU'};
  const opts={outputFaceBlendshapes:true,outputFacialTransformationMatrixes:true,numFaces:1};
  flV=await FaceLandmarker.createFromOptions(vis,{baseOptions:base,runningMode:'VIDEO',...opts});
  flI=await FaceLandmarker.createFromOptions(vis,{baseOptions:base,runningMode:'IMAGE',...opts});
  drawU=new DrawingUtils(ctxL);
  st('‚úì Model ready ‚Äî select webcam or capture window to begin.');
}

function euler(m){return{pitch:Math.asin(-m[9])*(180/Math.PI),yaw:Math.atan2(m[8],m[10])*(180/Math.PI),roll:Math.atan2(m[1],m[5])*(180/Math.PI)};}
function bs2obj(cats){const r={};cats.forEach(c=>{r[c.categoryName]=c.score;});return r;}
function c01(v){return Math.max(0,Math.min(1,v));}

function extract(res,useZero=true){
  if(!res.faceLandmarks?.length)return null;
  const bs=bs2obj(res.faceBlendshapes[0].categories);
  let y=0.5,p=0.5,r=0.5;
  if(res.facialTransformationMatrixes?.length){
    const eu=euler(res.facialTransformationMatrixes[0].data);
    if(useZero){
      y=c01(((eu.yaw-zero.yaw)/45+1)*0.5);
      p=c01(((eu.pitch-zero.pitch)/30+1)*0.5);
      r=c01(((eu.roll-zero.roll)/30+1)*0.5);
    }else{y=c01(eu.yaw/90+0.5);p=c01(eu.pitch/60+0.5);r=c01(eu.roll/60+0.5);}
  }
  return{yaw:y,pitch:p,roll:r,
    jawOpen:bs.jawOpen??0,
    smile:((bs.mouthSmileLeft??0)+(bs.mouthSmileRight??0))/2,
    frown:((bs.mouthFrownLeft??0)+(bs.mouthFrownRight??0))/2,
    leye:1-(bs.eyeBlinkLeft??0),reye:1-(bs.eyeBlinkRight??0),
    squint:((bs.eyeSquintLeft??0)+(bs.eyeSquintRight??0))/2,
    wide:((bs.eyeWideLeft??0)+(bs.eyeWideRight??0))/2,
    browInnerUp:bs.browInnerUp??0,
    browOuterUp:((bs.browOuterUpLeft??0)+(bs.browOuterUpRight??0))/2,
    browDown:((bs.browDownLeft??0)+(bs.browDownRight??0))/2,
    pucker:bs.mouthPucker??0,funnel:bs.mouthFunnel??0,cheekPuff:bs.cheekPuff??0
  };
}

let liveStream=null,liveRun=false,liveLast=-1;

async function startLive(mode){
  stopLive();
  try{
    liveStream=mode==='webcam'
      ?await navigator.mediaDevices.getUserMedia({video:{width:640,height:360,facingMode:'user'}})
      :await navigator.mediaDevices.getDisplayMedia({video:{cursor:'never'}});
    vidL.srcObject=liveStream;
    await new Promise(r=>vidL.addEventListener('loadeddata',r,{once:true}));
    liveRun=true;
    st(mode==='webcam'?'üì∑ Webcam live':'üñ• Window capture live');
    liveLoop();
  }catch(e){st('Error: '+e.message);}
}
function stopLive(){
  liveRun=false;
  if(liveStream){liveStream.getTracks().forEach(t=>t.stop());liveStream=null;}
  document.getElementById('live-ovr').textContent='Idle';
}

function liveLoop(){
  if(!liveRun||!flV) return requestAnimationFrame(liveLoop);
  canvasL.width=vidL.videoWidth||640;canvasL.height=vidL.videoHeight||360;
  ctxL.clearRect(0,0,canvasL.width,canvasL.height);
  ctxL.drawImage(vidL,0,0,canvasL.width,canvasL.height);
  if(vidL.currentTime===liveLast)return requestAnimationFrame(liveLoop);
  liveLast=vidL.currentTime;
  const res=flV.detectForVideo(vidL,performance.now());
  if(res.faceLandmarks?.length){
    drawU=new DrawingUtils(ctxL);
    drawU.drawConnectors(res.faceLandmarks[0],FaceLandmarker.FACE_LANDMARKS_TESSELATION,{color:'#fff1',lineWidth:.5});
    drawU.drawConnectors(res.faceLandmarks[0],FaceLandmarker.FACE_LANDMARKS_LEFT_EYE,{color:'#00d4ff',lineWidth:1.5});
    drawU.drawConnectors(res.faceLandmarks[0],FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE,{color:'#00d4ff',lineWidth:1.5});
    drawU.drawConnectors(res.faceLandmarks[0],FaceLandmarker.FACE_LANDMARKS_LIPS,{color:'#ffaa00',lineWidth:1.5});
    drawU.drawConnectors(res.faceLandmarks[0],FaceLandmarker.FACE_LANDMARKS_LEFT_EYEBROW,{color:'#ff88cc',lineWidth:1.5});
    drawU.drawConnectors(res.faceLandmarks[0],FaceLandmarker.FACE_LANDMARKS_RIGHT_EYEBROW,{color:'#ff88cc',lineWidth:1.5});
    const raw=extract(res);
    if(raw){
      const sm={};PARAMS.forEach(k=>{sm[k]=ema('L'+k,raw[k]);});
      dispatchOSC(sm);updPG('pg-live',sm);
      document.getElementById('live-ovr').textContent='‚úì '+(ws?.readyState===1?'OSC':'MIDI');
    }
  }else{document.getElementById('live-ovr').textContent='üëÅ No face';}
  requestAnimationFrame(liveLoop);
}

document.getElementById('btn-webcam').addEventListener('click',()=>startLive('webcam'));
document.getElementById('btn-capture').addEventListener('click',()=>startLive('capture'));
document.getElementById('btn-stop-live').addEventListener('click',stopLive);

let procFrames=null,procTriggers=[],procRun=false;

document.getElementById('video-file').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const vp=document.getElementById('video-proc');
  vp.src=URL.createObjectURL(f);vp.style.display='block';
  st('Loaded: '+f.name);
});

document.getElementById('btn-process').addEventListener('click',async()=>{
  const vp=document.getElementById('video-proc');
  if(!vp.src||!flI){st('Load a video file first');return;}
  procRun=true;procFrames=[];
  document.getElementById('btn-process').disabled=true;
  document.getElementById('btn-stop-proc').style.display='';
  document.getElementById('btn-export').disabled=true;
  document.getElementById('btn-upload').disabled=true;
  const fps=+document.getElementById('proc-fps').value||30;
  const step=1/fps,dur=vp.duration;
  st(`Processing ${dur.toFixed(1)}s @ ${fps}fps...`);
  let t=0;
  while(t<=dur&&procRun){
    vp.currentTime=t;
    await new Promise(r=>{vp.onseeked=r;});
    const res=flI.detect(vp);
    const raw=extract(res,false);
    if(raw)procFrames.push({timeMs:Math.round(t*1000),...raw});
    const pct=(t/dur*100).toFixed(1);
    document.getElementById('proc-pf').style.width=pct+'%';
    document.getElementById('proc-pl').textContent=`${pct}%  ‚Äî  ${procFrames.length} frames  ‚Äî  ${t.toFixed(2)}s`;
    t+=step;
    if(Math.round(t/step)%20===0)await new Promise(r=>setTimeout(r,0));
  }
  document.getElementById('btn-process').disabled=false;
  document.getElementById('btn-stop-proc').style.display='none';
  document.getElementById('btn-export').disabled=false;
  document.getElementById('btn-upload').disabled=false;
  document.getElementById('proc-stats').textContent=`${procFrames.length} frames, ${dur.toFixed(1)}s`;
  st(`‚úì Done ‚Äî ${procFrames.length} frames. Add triggers then export.`);
  procRun=false;
});
document.getElementById('btn-stop-proc').addEventListener('click',()=>{procRun=false;});

function renderTriggers(){
  const el=document.getElementById('trigger-list');el.innerHTML='';
  procTriggers.forEach((tr,i)=>{
    const row=document.createElement('div');row.className='tr-row row';
    row.innerHTML=`
      <input type="number" value="${tr.timeMs}" style="width:80px" placeholder="ms" data-i="${i}" data-f="t">
      <span style="font-size:12px;color:var(--grey2)">ms</span>
      <input type="text" value="${tr.address}" style="flex:1;min-width:220px" placeholder="/beyond/general/StartCue" data-i="${i}" data-f="a">
      <button data-del="${i}" class="red sm">‚úï</button>`;
    el.appendChild(row);
  });
  el.querySelectorAll('input').forEach(inp=>inp.addEventListener('change',e=>{
    const i=+e.target.dataset.i;
    if(e.target.dataset.f==='t')procTriggers[i].timeMs=+e.target.value;
    if(e.target.dataset.f==='a')procTriggers[i].address=e.target.value;
  }));
  el.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',e=>{
    procTriggers.splice(+e.target.dataset.del,1);renderTriggers();
  }));
}

document.getElementById('btn-add-tr').addEventListener('click',()=>{
  procTriggers.push({timeMs:0,address:'/beyond/general/StartCue',args:['MOUTH']});renderTriggers();
});
document.getElementById('btn-auto-tr').addEventListener('click',()=>{
  const page=parseInt(document.getElementById('cfg-page').value)||0;
  const cues=[
    parseInt(document.getElementById('cfg-mouth').value)||0,
    parseInt(document.getElementById('cfg-leye').value)||1,
    parseInt(document.getElementById('cfg-reye').value)||2,
    parseInt(document.getElementById('cfg-brows').value)||3,
  ];
  procTriggers=cues.map(ci=>({timeMs:0,address:`/beyond/general/CueDown`,args:[page,ci]}));
  renderTriggers();st('Auto triggers: CueDown for all face cues at t=0');
});

function buildJSON(){
  return{
    meta:{fps:+document.getElementById('proc-fps').value||30,
          durationMs:procFrames?.[procFrames.length-1]?.timeMs||0},
    triggers:procTriggers,
    frames:procFrames||[]
  };
}
document.getElementById('btn-export').addEventListener('click',()=>{
  if(!procFrames)return;
  const blob=new Blob([JSON.stringify(buildJSON(),null,0)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='face-data.json';a.click();
  st('Downloaded face-data.json');
});
document.getElementById('btn-upload').addEventListener('click',()=>{
  if(!procFrames||ws?.readyState!==1){st('Not connected to bridge');return;}
  sendWS({type:'loadData',data:buildJSON()});st('Sent to bridge.');
});

let pbData=null,worker=null;

document.getElementById('data-file').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    pbData=JSON.parse(ev.target.result);
    const dur=(pbData.frames[pbData.frames.length-1].timeMs/1000).toFixed(1);
    document.getElementById('data-info').textContent=
      `${pbData.frames.length} frames ¬∑ ${dur}s ¬∑ ${pbData.triggers?.length||0} triggers`;
    document.getElementById('btn-play').disabled=false;
    document.getElementById('btn-play-now').disabled=false;
    if(ws?.readyState===1){sendWS({type:'loadData',data:pbData});st(`Loaded + sent to bridge: ${pbData.frames.length} frames`);}
    else st(`Loaded: ${pbData.frames.length} frames`);
  };
  r.readAsText(f);
});

async function startPB(cd){
  if(!pbData)return;
  if(cd>0){
    document.getElementById('countdown').style.display='block';
    for(let i=cd;i>0;i--){
      document.getElementById('countdown').textContent=i;
      await new Promise(r=>setTimeout(r,1000));
    }
    document.getElementById('countdown').style.display='none';
  }
  sendWS({type:'tcMode',mode:tcMode(),fps:tcFPS(),host:tcHost()});
  if(worker) worker.terminate();
  worker=new Worker('playback-worker.js');
  worker.onmessage=e=>{
    const m=e.data;
    switch(m.type){
      case 'frame':
        dispatchOSC(m.params,m.timeMs);
        updPG('pg-pb',m.params);
        showTC(m.timeMs);
        if(tcMode()==='send') sendWS({type:'sendTC',timeMs:m.timeMs,fps:tcFPS(),host:tcHost()});
        break;
      case 'trigger':
        sendWS({type:'trigger',address:m.address,args:m.args});
        st(`Trigger: ${m.address}`);
        break;
      case 'progress':
        const pct=Math.min(100,m.elapsed/m.total*100).toFixed(1);
        document.getElementById('pb-pf').style.width=pct+'%';
        document.getElementById('pb-pl').textContent=`${(m.elapsed/1000).toFixed(2)}s / ${(m.total/1000).toFixed(2)}s`;
        break;
      case 'done':
        document.getElementById('btn-stop-pb').style.display='none';
        document.getElementById('tc-status').textContent='done';
        st('‚úì Playback complete');
        break;
    }
  };
  worker.postMessage({type:'start',frames:pbData.frames,triggers:pbData.triggers||[],sendTC:tcMode()==='send'});
  document.getElementById('btn-stop-pb').style.display='';
  document.getElementById('tc-status').textContent='sending ‚ñ∂';
  st('‚ñ∂ Playing ‚Äî ArtNet TC + OSC streaming...');
}

function stopPB(){
  if(worker){worker.postMessage({type:'stop'});worker.terminate();worker=null;}
  document.getElementById('btn-stop-pb').style.display='none';
  document.getElementById('tc-status').textContent='stopped';
  st('Stopped.');
}

document.getElementById('btn-play').addEventListener('click',()=>startPB(+document.getElementById('cd-secs').value||3));
document.getElementById('btn-play-now').addEventListener('click',()=>startPB(0));
document.getElementById('btn-stop-pb').addEventListener('click',stopPB);

initMP();
</script>
</body>
</html>
